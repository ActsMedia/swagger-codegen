// CoreDataBuilders.swift
// API Version {{appVersion}}
//

import Foundation
import CoreData

protocol CoreDataBuildable {
    associatedtype T: NSManagedObject
    func createAndOrUpdateManagedObject(in context: NSManagedObjectContext) -> T?
}

extension CoreDataBuildable {
    
    /// Convenience function to speed up build time
    ///
    /// - Parameter item: item to be unwrapped
    /// - Returns: false if item is nil, otherwise item's unwrapped value
    fileprivate func boolOrFalseForNil(_ item: Bool?) -> Bool {
        guard let item = item else {
            return false
        }
        return item
    }
}

{{#models}}{{#model}}{{#isDatabaseModel}}{{#isProtocolUUIDType}}extension {{plainClassName}}: CoreDataBuildable {

    func createAndOrUpdateManagedObject(in context: NSManagedObjectContext) -> {{databaseModelName}}? {

        guard let cd{{plainClassName}} = {{databaseModelName}}.getOrCreate(for: uuid, in: context, with: {{^isProtocolSoftDeletableType}} false){{/isProtocolSoftDeletableType}}{{#isProtocolSoftDeletableType}}boolOrFalseForNil(deleted_on_server)){{/isProtocolSoftDeletableType}} else {
            return nil;
        }
{{#vars}}{{^databaseIsRelation}}        
        cd{{plainClassName}}.{{nameInCamelCase}} = {{nameInCamelCase}}{{/databaseIsRelation}}{{#databaseIsRelation}}{{#databaseRelationCreateLinkMethods}}{{#databaseRelationIsToManyReference}}
        
        cd{{plainClassName}}.{{databaseRelationPropertyName}} = {{databaseRelationModelType}}.classedObjects(for: {{name}}, in: context) 
        if cd{{plainClassName}}.{{databaseRelationPropertyName}}?.count != {{name}}?.count {
			print("Data integrity failure in {{plainClassName}}. Missing connections for {{name}}: \(String(describing: {{name}}))")
		}{{/databaseRelationIsToManyReference}}{{^databaseRelationIsToManyReference}}

        if let uuid = {{name}}, let object: {{databaseRelationModelType}} = {{databaseRelationModelType}}.classedObject(for: uuid, in: context)  {
            cd{{plainClassName}}.{{databaseRelationPropertyName}} = object
        } else {
            print("******\nData integrity failure in {{plainClassName}}. The uuid \(String(describing: uuid)) for {{name}}  could not be found.\n***********")
        }{{/databaseRelationIsToManyReference}}{{/databaseRelationCreateLinkMethods}}{{/databaseIsRelation}}{{/vars}}
        return cd{{plainClassName}}
    }
}

{{/isProtocolUUIDType}}{{/isDatabaseModel}}{{/model}}{{/models}}